---

- name: 'Check current Jira version'
  ansible.builtin.command:
    cmd: grep -Po '(?<=^version=)\N*$' '{{ jira__application_path }}/atlassian-jira/META-INF/maven/com.atlassian.jira/jira-webapp-dist/pom.properties'
  failed_when: false
  changed_when: false
  register: jira__version_check

- name: 'Download and unarchive Jira'
  ansible.builtin.unarchive:
    src: '{{ jira__download_url }}'
    dest: '{{ jira__install_path }}'
    extra_opts:
      - --strip-components=1
    remote_src: true
    owner: '{{ jira__username }}'
    group: '{{ jira__group }}'
  when:
    - jira__version_check.stdout is not defined or
      jira__version not in jira__version_check.stdout

- name: 'Create symbolic link for Jira'
  ansible.builtin.file:
    src: '{{ jira__install_path }}'
    dest: '{{ jira__application_path }}'
    state: link
